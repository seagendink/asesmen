<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMaster - Aplikasi Quiz Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, push, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration (Demo - Ganti dengan config Anda)
        const firebaseConfig = {
		  apiKey: "AIzaSyA-FCXv948AX-kdp2W9oywwRsu4_e7Gq48",
		  authDomain: "asessmen-4d52b.firebaseapp.com",
		  projectId: "asessmen-4d52b",
		  storageBucket: "asessmen-4d52b.firebasestorage.app",
		  messagingSenderId: "93917798261",
		  appId: "1:93917798261:web:dc833792732a7d48413d3c",
         databaseURL: "https://asessmen-4d52b-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase available globally
        window.firebase = { database, ref, set, get, onValue, push, update };
        window.firebaseInitialized = true;
        
        // Initialize app after Firebase is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.initializeQuizApp) {
                    window.initializeQuizApp();
                }
            }, 1000);
        });
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        .slide-up {
            animation: slideUp 0.6s ease-out;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .sync-online {
            background: #10b981;
            color: white;
        }
        
        .sync-offline {
            background: #ef4444;
            color: white;
        }
        
        .sync-syncing {
            background: #f59e0b;
            color: white;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s linear;
        }
        
        .question-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .option-button {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .option-button:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .option-button.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }
        
        .progress-bar {
            transition: width 0.5s ease;
        }
        
        .drop-zone {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        
        .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Sync Status Indicator -->
    <div id="syncIndicator" class="sync-indicator sync-offline">
        <i class="fas fa-wifi mr-1"></i>
        <span id="syncStatus">Offline</span>
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-graduation-cap text-2xl text-indigo-600 mr-2"></i>
                        <span class="text-xl font-bold text-gray-900">QuizMaster</span>
                        <span class="ml-2 bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">
                            <i class="fas fa-cloud mr-1"></i>Cloud Sync
                        </span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="adminBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-cog mr-2"></i>Admin
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div id="mainContent" class="fade-in">
        <!-- Landing Page -->
        <div id="landingPage" class="gradient-bg min-h-screen flex items-center justify-center p-4">
            <div class="max-w-4xl mx-auto text-center text-white">
                <div class="slide-up">
                    <h1 class="text-5xl md:text-6xl font-bold mb-6">
                        Selamat Datang di <span class="text-yellow-300">QuizMaster</span>
                    </h1>
                    <p class="text-xl md:text-2xl mb-4 opacity-90">
                        Platform quiz interaktif dengan sinkronisasi otomatis
                    </p>
                    <div class="bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-xl p-4 mb-8">
                        <div class="flex items-center justify-center space-x-4 text-sm">
                            <div class="flex items-center">
                                <i class="fas fa-cloud text-green-300 mr-2"></i>
                                <span>Auto-Sync Database</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-mobile-alt text-blue-300 mr-2"></i>
                                <span>Multi-Device</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-bolt text-yellow-300 mr-2"></i>
                                <span>Real-time</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6 mt-12">
                        <div class="card-hover bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-xl p-6 border border-white border-opacity-30">
                            <i class="fas fa-user-graduate text-4xl mb-4 text-yellow-300"></i>
                            <h3 class="text-xl font-semibold mb-2">Untuk Siswa</h3>
                            <p class="opacity-90 mb-4">Ikuti quiz dari HP atau komputer manapun dengan data yang selalu sinkron</p>
                            <button onclick="showStudentLogin()" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 px-6 py-3 rounded-lg font-semibold transition-colors">
                                Mulai Quiz
                            </button>
                        </div>
                        <div class="card-hover bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-xl p-6 border border-white border-opacity-30">
                            <i class="fas fa-chalkboard-teacher text-4xl mb-4 text-yellow-300"></i>
                            <h3 class="text-xl font-semibold mb-2">Untuk Guru</h3>
                            <p class="opacity-90 mb-4">Kelola soal dan siswa dengan sinkronisasi otomatis ke cloud database</p>
                            <button onclick="showAdminLogin()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                Dashboard Admin
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Login -->
        <div id="studentLogin" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-up">
                <div class="text-center mb-6">
                    <i class="fas fa-user-graduate text-4xl text-indigo-600 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-900">Login Siswa</h2>
                    <p class="text-gray-600">Masukkan username dan password Anda</p>
                    <div class="mt-2 text-xs text-green-600">
                        <i class="fas fa-cloud mr-1"></i>Data tersinkronisasi otomatis
                    </div>
                </div>
                <form id="studentForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="studentUsername" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="studentPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-semibold transition-colors">
                        Login
                    </button>
                </form>
                <button onclick="showLanding()" class="w-full mt-4 text-gray-600 hover:text-gray-800 transition-colors">
                    ← Kembali
                </button>
            </div>
        </div>

        <!-- Quiz Instructions -->
        <div id="quizInstructions" class="hidden min-h-screen bg-gray-50 py-8">
            <div class="max-w-4xl mx-auto px-4">
                <div class="bg-white rounded-2xl shadow-lg p-8 slide-up">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-900 mb-2" id="quizTitle">Quiz Informatika - Algoritma Dasar</h1>
                        <p class="text-gray-600">Bacalah petunjuk dengan seksama sebelum memulai</p>
                        <div class="mt-2 text-sm text-green-600">
                            <i class="fas fa-sync-alt mr-1"></i>Soal terbaru dari database cloud
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-8 mb-8">
                        <div class="bg-blue-50 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-blue-900 mb-4">
                                <i class="fas fa-info-circle mr-2"></i>Petunjuk Umum
                            </h3>
                            <ul class="space-y-2 text-blue-800">
                                <li>• Bacalah setiap soal dengan teliti</li>
                                <li>• Pilih jawaban yang paling tepat</li>
                                <li>• Waktu pengerjaan: <span class="font-semibold" id="totalTime">30 menit</span></li>
                                <li>• Jumlah soal: <span class="font-semibold" id="totalQuestions">Loading...</span></li>
                                <li>• Tidak ada pengurangan nilai untuk jawaban salah</li>
                            </ul>
                        </div>
                        
                        <div class="bg-green-50 rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-green-900 mb-4">
                                <i class="fas fa-lightbulb mr-2"></i>Tips Mengerjakan
                            </h3>
                            <ul class="space-y-2 text-green-800">
                                <li>• Kerjakan soal yang mudah terlebih dahulu</li>
                                <li>• Perhatikan waktu yang tersisa</li>
                                <li>• Periksa kembali jawaban sebelum submit</li>
                                <li>• Tetap tenang dan fokus</li>
                                <li>• Jangan lupa berdoa sebelum memulai</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button onclick="startQuiz()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-xl font-semibold text-lg transition-colors pulse-animation">
                            <i class="fas fa-play mr-2"></i>Mulai Quiz Sekarang
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Page -->
        <div id="quizPage" class="hidden min-h-screen bg-gray-50">
            <!-- Quiz Header -->
            <div class="bg-white shadow-lg sticky top-16 z-40">
                <div class="max-w-6xl mx-auto px-4 py-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-600">
                                Soal <span id="currentQuestion">1</span> dari <span id="totalQuestionsDisplay">Loading...</span>
                            </div>
                            <div class="w-64 bg-gray-200 rounded-full h-2">
                                <div id="progressBar" class="progress-bar bg-indigo-600 h-2 rounded-full" style="width: 5%"></div>
                            </div>
                        </div>
                        
                        <!-- Timer -->
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <svg class="w-16 h-16 transform -rotate-90">
                                    <circle cx="32" cy="32" r="28" stroke="#e5e7eb" stroke-width="4" fill="none"></circle>
                                    <circle id="timerCircle" cx="32" cy="32" r="28" stroke="#ef4444" stroke-width="4" fill="none" class="timer-circle"></circle>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span id="timeDisplay" class="text-sm font-bold text-red-600">30:00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Question Content -->
            <div class="max-w-4xl mx-auto px-4 py-8">
                <div id="questionContainer" class="question-card rounded-2xl p-8 mb-6">
                    <!-- Question will be loaded here -->
                </div>
                
                <!-- Navigation -->
                <div class="flex justify-between items-center">
                    <button id="prevBtn" onclick="previousQuestion()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left mr-2"></i>Sebelumnya
                    </button>
                    
                    <div class="flex space-x-2">
                        <button onclick="showQuestionNav()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition-colors">
                            <i class="fas fa-th mr-2"></i>Navigasi Soal
                        </button>
                        <button id="submitBtn" onclick="submitQuiz()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-paper-plane mr-2"></i>Submit Quiz
                        </button>
                    </div>
                    
                    <button id="nextBtn" onclick="nextQuestion()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        Selanjutnya<i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Login -->
        <div id="adminLogin" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-up">
                <div class="text-center mb-6">
                    <i class="fas fa-shield-alt text-4xl text-indigo-600 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-900">Login Admin</h2>
                    <p class="text-gray-600">Masukkan kredensial admin</p>
                    <div class="mt-2 text-xs text-green-600">
                        <i class="fas fa-database mr-1"></i>Terhubung ke cloud database
                    </div>
                </div>
                <form id="adminLoginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="adminUsername" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="adminPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-semibold transition-colors">
                        Login
                    </button>
                </form>
                <button onclick="showLanding()" class="w-full mt-4 text-gray-600 hover:text-gray-800 transition-colors">
                    ← Kembali
                </button>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="hidden min-h-screen bg-gray-50">
            <div class="max-w-7xl mx-auto px-4 py-8">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Dashboard Admin</h1>
                    <p class="text-gray-600">Kelola quiz dengan sinkronisasi otomatis ke cloud database</p>
                    <div class="mt-2 text-sm text-green-600">
                        <i class="fas fa-sync-alt mr-1"></i>
                        <span id="lastSyncTime">Sinkronisasi otomatis aktif</span>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center">
                            <div class="p-3 bg-blue-100 rounded-full">
                                <i class="fas fa-question-circle text-blue-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">Total Soal</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalQuestionsCount">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center">
                            <div class="p-3 bg-green-100 rounded-full">
                                <i class="fas fa-users text-green-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">Total Siswa</p>
                                <p class="text-2xl font-bold text-gray-900" id="totalStudents">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center">
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <i class="fas fa-clock text-yellow-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">Durasi Quiz</p>
                                <p class="text-2xl font-bold text-gray-900" id="quizDuration">30 min</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center">
                            <div class="p-3 bg-purple-100 rounded-full">
                                <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">Rata-rata Nilai</p>
                                <p class="text-2xl font-bold text-gray-900" id="averageScore">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <button onclick="showAddQuestion()" class="bg-indigo-600 hover:bg-indigo-700 text-white p-6 rounded-xl font-semibold text-lg transition-colors card-hover">
                        <i class="fas fa-plus-circle text-2xl mb-2"></i>
                        <div>Tambah Soal</div>
                    </button>
                    
                    <button onclick="showImportQuestions()" class="bg-green-600 hover:bg-green-700 text-white p-6 rounded-xl font-semibold text-lg transition-colors card-hover">
                        <i class="fas fa-file-import text-2xl mb-2"></i>
                        <div>Import Soal</div>
                    </button>
                    
                    <button onclick="showStudentManagement()" class="bg-orange-600 hover:bg-orange-700 text-white p-6 rounded-xl font-semibold text-lg transition-colors card-hover">
                        <i class="fas fa-users text-2xl mb-2"></i>
                        <div>Kelola Siswa</div>
                    </button>
                    
                    <button onclick="showResults()" class="bg-purple-600 hover:bg-purple-700 text-white p-6 rounded-xl font-semibold text-lg transition-colors card-hover">
                        <i class="fas fa-chart-bar text-2xl mb-2"></i>
                        <div>Lihat Hasil</div>
                    </button>
                </div>
                
                <!-- Database Setup -->
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-lg p-6 mb-8 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">
                                <i class="fas fa-database mr-2"></i>Setup Database Cloud
                            </h3>
                            <p class="text-blue-100 text-sm">Konfigurasi Firebase untuk sinkronisasi otomatis antar device</p>
                        </div>
                        <button onclick="showDatabaseSetup()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-cog mr-2"></i>Setup Database
                        </button>
                    </div>
                </div>
                
                <!-- Questions List -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900">Daftar Soal</h2>
                        <div class="flex space-x-2">
                            <button onclick="syncNow()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Sync Now
                            </button>
                            <button onclick="resetToSampleData()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-refresh mr-2"></i>Reset Data
                            </button>
                            <button onclick="exportResults()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-download mr-2"></i>Export Excel
                            </button>
                        </div>
                    </div>
                    <div id="questionsList" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Memuat data dari database...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals and overlays will be added here -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div id="modalContent" class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal content will be loaded here -->
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let questions = [];
        let students = [];
        let currentQuestionIndex = 0;
        let userAnswers = {};
        let quizTimer = null;
        let timeRemaining = 1800; // 30 minutes in seconds
        let adminCredentials = { username: 'admin', password: 'admin123' };
        let isOnline = false;
        let syncInterval = null;
        let lastSyncTime = null;

        // Firebase Database Functions
        const DatabaseManager = {
            isInitialized: false,
            
            async init() {
                if (!window.firebaseInitialized) {
                    console.log('Firebase not initialized yet');
                    return false;
                }
                
                this.isInitialized = true;
                this.updateSyncStatus('online');
                this.startAutoSync();
                return true;
            },
            
            async saveQuestions(questionsData) {
                if (!this.isInitialized) return false;
                
                try {
                    this.updateSyncStatus('syncing');
                    const { database, ref, set } = window.firebase;
                    await set(ref(database, 'questions'), questionsData);
                    this.updateLastSyncTime();
                    this.updateSyncStatus('online');
                    return true;
                } catch (error) {
                    console.error('Error saving questions:', error);
                    this.updateSyncStatus('offline');
                    return false;
                }
            },
            
            async loadQuestions() {
                if (!this.isInitialized) return null;
                
                try {
                    const { database, ref, get } = window.firebase;
                    const snapshot = await get(ref(database, 'questions'));
                    return snapshot.exists() ? snapshot.val() : null;
                } catch (error) {
                    console.error('Error loading questions:', error);
                    return null;
                }
            },
            
            async saveStudents(studentsData) {
                if (!this.isInitialized) return false;
                
                try {
                    this.updateSyncStatus('syncing');
                    const { database, ref, set } = window.firebase;
                    await set(ref(database, 'students'), studentsData);
                    this.updateLastSyncTime();
                    this.updateSyncStatus('online');
                    return true;
                } catch (error) {
                    console.error('Error saving students:', error);
                    this.updateSyncStatus('offline');
                    return false;
                }
            },
            
            async loadStudents() {
                if (!this.isInitialized) return null;
                
                try {
                    const { database, ref, get } = window.firebase;
                    const snapshot = await get(ref(database, 'students'));
                    return snapshot.exists() ? snapshot.val() : null;
                } catch (error) {
                    console.error('Error loading students:', error);
                    return null;
                }
            },
            
            async saveResult(resultData) {
                if (!this.isInitialized) return false;
                
                try {
                    const { database, ref, push } = window.firebase;
                    await push(ref(database, 'results'), resultData);
                    return true;
                } catch (error) {
                    console.error('Error saving result:', error);
                    return false;
                }
            },
            
            async loadResults() {
                if (!this.isInitialized) return null;
                
                try {
                    const { database, ref, get } = window.firebase;
                    const snapshot = await get(ref(database, 'results'));
                    if (snapshot.exists()) {
                        const results = [];
                        snapshot.forEach(child => {
                            results.push(child.val());
                        });
                        return results;
                    }
                    return null;
                } catch (error) {
                    console.error('Error loading results:', error);
                    return null;
                }
            },
            
            startAutoSync() {
                // Auto sync every 30 seconds
                if (syncInterval) clearInterval(syncInterval);
                
                syncInterval = setInterval(async () => {
                    if (this.isInitialized) {
                        await this.syncData();
                    }
                }, 30000);
            },
            
            async syncData() {
                try {
                    // Load latest data from Firebase
                    const [cloudQuestions, cloudStudents] = await Promise.all([
                        this.loadQuestions(),
                        this.loadStudents()
                    ]);
                    
                    let hasUpdates = false;
                    
                    // Update questions if cloud has newer data
                    if (cloudQuestions && JSON.stringify(cloudQuestions) !== JSON.stringify(questions)) {
                        questions = cloudQuestions;
                        hasUpdates = true;
                    }
                    
                    // Update students if cloud has newer data
                    if (cloudStudents && JSON.stringify(cloudStudents) !== JSON.stringify(students)) {
                        students = cloudStudents;
                        hasUpdates = true;
                    }
                    
                    if (hasUpdates) {
                        // Update localStorage as backup
                        saveDataToStorage();
                        
                        // Update UI if on admin dashboard
                        if (!document.getElementById('adminDashboard').classList.contains('hidden')) {
                            loadQuestionsList();
                            updateStats();
                        }
                        
                        showNotification('Data berhasil disinkronisasi dari cloud!', 'success');
                    }
                    
                    this.updateLastSyncTime();
                } catch (error) {
                    console.error('Sync error:', error);
                }
            },
            
            updateSyncStatus(status) {
                const indicator = document.getElementById('syncIndicator');
                const statusText = document.getElementById('syncStatus');
                
                indicator.className = 'sync-indicator';
                
                switch (status) {
                    case 'online':
                        indicator.classList.add('sync-online');
                        statusText.innerHTML = '<i class="fas fa-check mr-1"></i>Online';
                        isOnline = true;
                        break;
                    case 'offline':
                        indicator.classList.add('sync-offline');
                        statusText.innerHTML = '<i class="fas fa-times mr-1"></i>Offline';
                        isOnline = false;
                        break;
                    case 'syncing':
                        indicator.classList.add('sync-syncing');
                        statusText.innerHTML = '<i class="fas fa-sync-alt fa-spin mr-1"></i>Syncing';
                        break;
                }
            },
            
            updateLastSyncTime() {
                lastSyncTime = new Date();
                const timeElement = document.getElementById('lastSyncTime');
                if (timeElement) {
                    timeElement.textContent = `Terakhir sync: ${lastSyncTime.toLocaleTimeString('id-ID')}`;
                }
            }
        };

        // Sample questions data
        const sampleQuestions = [
            {
                id: 1,
                type: 'multiple_choice',
                question: 'Apa yang dimaksud dengan algoritma?',
                options: [
                    'Bahasa pemrograman',
                    'Langkah-langkah sistematis untuk menyelesaikan masalah',
                    'Perangkat keras komputer',
                    'Sistem operasi'
                ],
                correct: 1,
                image: null,
                video: null
            },
            {
                id: 2,
                type: 'true_false',
                question: 'Flowchart adalah representasi visual dari algoritma.',
                options: ['Benar', 'Salah'],
                correct: 0,
                image: null,
                video: null
            },
            {
                id: 3,
                type: 'multiple_choice',
                question: 'Manakah yang bukan termasuk struktur kontrol dalam pemrograman?',
                options: [
                    'Sequence (Urutan)',
                    'Selection (Pemilihan)',
                    'Iteration (Perulangan)',
                    'Compilation (Kompilasi)'
                ],
                correct: 3,
                image: null,
                video: null
            }
        ];

        // Sample students data
        const sampleStudents = [
            { id: 1, username: 'siswa001', password: 'pass123', name: 'Ahmad Rizki', class: '7A', number: 1 },
            { id: 2, username: 'siswa002', password: 'pass123', name: 'Siti Nurhaliza', class: '7A', number: 2 },
            { id: 3, username: 'siswa003', password: 'pass123', name: 'Budi Santoso', class: '7B', number: 1 }
        ];

        // Initialize app
        window.initializeQuizApp = async function() {
            console.log('Initializing QuizMaster...');
            
            // Initialize Firebase Database
            const dbInitialized = await DatabaseManager.init();
            
            if (dbInitialized) {
                console.log('Database connected, loading cloud data...');
                await loadDataFromCloud();
            } else {
                console.log('Database not available, using local data...');
                loadDataFromStorage();
            }
            
            updateStats();
        };

        // Navigation functions
        function showLanding() {
            hideAllPages();
            document.getElementById('landingPage').classList.remove('hidden');
        }

        function showStudentLogin() {
            hideAllPages();
            document.getElementById('studentLogin').classList.remove('hidden');
        }

        function showAdminLogin() {
            hideAllPages();
            document.getElementById('adminLogin').classList.remove('hidden');
        }

        function hideAllPages() {
            const pages = ['landingPage', 'studentLogin', 'quizInstructions', 'quizPage', 'adminLogin', 'adminDashboard'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
        }

        // Student login handling
        document.getElementById('studentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('studentUsername').value;
            const password = document.getElementById('studentPassword').value;
            
            // Ensure we have latest student data
            if (DatabaseManager.isInitialized) {
                const cloudStudents = await DatabaseManager.loadStudents();
                if (cloudStudents) {
                    students = cloudStudents;
                }
            }
            
            const student = students.find(s => s.username === username && s.password === password);
            
            if (student) {
                currentUser = student;
                showQuizInstructions();
            } else {
                alert('Username atau password salah!');
            }
        });

        function showQuizInstructions() {
            hideAllPages();
            document.getElementById('quizInstructions').classList.remove('hidden');
            document.getElementById('totalQuestions').textContent = questions.length;
        }

        async function startQuiz() {
            // Ensure we have latest questions
            if (DatabaseManager.isInitialized) {
                const cloudQuestions = await DatabaseManager.loadQuestions();
                if (cloudQuestions) {
                    questions = cloudQuestions;
                }
            }
            
            hideAllPages();
            document.getElementById('quizPage').classList.remove('hidden');
            currentQuestionIndex = 0;
            userAnswers = {};
            timeRemaining = 1800; // Reset timer
            startTimer();
            loadQuestion();
            updateProgress();
        }

        // Timer functions
        function startTimer() {
            const circle = document.getElementById('timerCircle');
            const display = document.getElementById('timeDisplay');
            const totalTime = 1800;
            
            quizTimer = setInterval(() => {
                timeRemaining--;
                
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                display.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Update circle progress
                const progress = (totalTime - timeRemaining) / totalTime;
                const offset = 283 - (progress * 283);
                circle.style.strokeDashoffset = offset;
                
                // Change color based on time remaining
                if (timeRemaining <= 300) { // Last 5 minutes
                    circle.style.stroke = '#ef4444'; // Red
                } else if (timeRemaining <= 600) { // Last 10 minutes
                    circle.style.stroke = '#f59e0b'; // Yellow
                } else {
                    circle.style.stroke = '#10b981'; // Green
                }
                
                if (timeRemaining <= 0) {
                    clearInterval(quizTimer);
                    submitQuiz();
                }
            }, 1000);
        }

        // Question loading and navigation
        function loadQuestion() {
            const question = questions[currentQuestionIndex];
            if (!question) return;
            
            const container = document.getElementById('questionContainer');
            let optionsHtml = '';
            
            switch(question.type) {
                case 'multiple_choice':
                    optionsHtml = question.options.map((option, index) => `
                        <button class="option-button w-full text-left p-4 rounded-lg border-2 mb-3 hover:bg-gray-50 transition-colors" 
                                onclick="selectAnswer(${index})" data-option="${index}">
                            <span class="font-medium">${String.fromCharCode(65 + index)}.</span> ${option}
                        </button>
                    `).join('');
                    break;
                    
                case 'true_false':
                    optionsHtml = question.options.map((option, index) => `
                        <button class="option-button w-full text-left p-4 rounded-lg border-2 mb-3 hover:bg-gray-50 transition-colors" 
                                onclick="selectAnswer(${index})" data-option="${index}">
                            <span class="font-medium">${index === 0 ? 'A' : 'B'}.</span> ${option}
                        </button>
                    `).join('');
                    break;
            }
            
            container.innerHTML = `
                <div class="mb-6">
                    <div class="flex items-center mb-4">
                        <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium">
                            ${question.type === 'multiple_choice' ? 'Pilihan Ganda' : 'Benar/Salah'}
                        </span>
                        <span class="ml-2 bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">
                            <i class="fas fa-cloud mr-1"></i>Cloud Sync
                        </span>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">
                        ${currentQuestionIndex + 1}. ${question.question}
                    </h2>
                    ${question.image ? `<img src="${question.image}" class="max-w-full h-auto rounded-lg mb-4" alt="Question image">` : ''}
                    ${question.video ? `<video controls class="max-w-full h-auto rounded-lg mb-4"><source src="${question.video}" type="video/mp4"></video>` : ''}
                </div>
                <div class="space-y-3">
                    ${optionsHtml}
                </div>
            `;
            
            // Restore previous answer if exists
            if (userAnswers[question.id] !== undefined) {
                const selectedButton = container.querySelector(`[data-option="${userAnswers[question.id]}"]`);
                if (selectedButton) {
                    selectedButton.classList.add('selected');
                }
            }
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').style.display = currentQuestionIndex === questions.length - 1 ? 'none' : 'block';
            document.getElementById('submitBtn').style.display = currentQuestionIndex === questions.length - 1 ? 'block' : 'none';
            
            // Update question counter
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestionsDisplay').textContent = questions.length;
        }

        function selectAnswer(optionIndex) {
            const question = questions[currentQuestionIndex];
            userAnswers[question.id] = optionIndex;
            
            // Update UI
            const container = document.getElementById('questionContainer');
            const buttons = container.querySelectorAll('.option-button');
            buttons.forEach(btn => btn.classList.remove('selected'));
            buttons[optionIndex].classList.add('selected');
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
                updateProgress();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
                updateProgress();
            }
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        async function submitQuiz() {
            if (quizTimer) {
                clearInterval(quizTimer);
            }
            
            // Calculate score
            let correct = 0;
            questions.forEach(question => {
                if (userAnswers[question.id] === question.correct) {
                    correct++;
                }
            });
            
            const score = Math.round((correct / questions.length) * 100);
            
            // Save result
            const result = {
                student: currentUser,
                score: score,
                correct: correct,
                total: questions.length,
                answers: userAnswers,
                timestamp: new Date().toISOString()
            };
            
            // Save to cloud database
            if (DatabaseManager.isInitialized) {
                await DatabaseManager.saveResult(result);
            }
            
            // Save to localStorage as backup
            saveResult(result);
            showResult(result);
        }

        function showResult(result) {
            const modal = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="p-8 text-center">
                    <div class="mb-6">
                        <div class="w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center ${result.score >= 70 ? 'bg-green-100' : 'bg-red-100'}">
                            <i class="fas ${result.score >= 70 ? 'fa-check text-green-600' : 'fa-times text-red-600'} text-3xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Quiz Selesai!</h2>
                        <p class="text-gray-600">Terima kasih ${result.student.name}</p>
                        <div class="mt-2 text-sm text-green-600">
                            <i class="fas fa-cloud-upload-alt mr-1"></i>Hasil tersimpan di cloud database
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <div class="text-3xl font-bold ${result.score >= 70 ? 'text-green-600' : 'text-red-600'}">${result.score}</div>
                                <div class="text-sm text-gray-600">Nilai</div>
                            </div>
                            <div>
                                <div class="text-3xl font-bold text-gray-900">${result.correct}/${result.total}</div>
                                <div class="text-sm text-gray-600">Benar</div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="closeModal(); showLanding();" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        Kembali ke Beranda
                    </button>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // Admin functions
        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (username === adminCredentials.username && password === adminCredentials.password) {
                showAdminDashboard();
            } else {
                alert('Username atau password salah!');
            }
        });

        async function showAdminDashboard() {
            hideAllPages();
            document.getElementById('adminDashboard').classList.remove('hidden');
            
            // Load latest data from cloud
            if (DatabaseManager.isInitialized) {
                await DatabaseManager.syncData();
            }
            
            loadQuestionsList();
            updateStats();
        }

        // Data persistence functions
        function saveDataToStorage() {
            localStorage.setItem('quizQuestions', JSON.stringify(questions));
            localStorage.setItem('quizStudents', JSON.stringify(students));
        }

        async function loadDataFromCloud() {
            try {
                const [cloudQuestions, cloudStudents] = await Promise.all([
                    DatabaseManager.loadQuestions(),
                    DatabaseManager.loadStudents()
                ]);
                
                if (cloudQuestions && cloudQuestions.length > 0) {
                    questions = cloudQuestions;
                } else {
                    // Use sample data if no cloud data
                    questions = [...sampleQuestions];
                    await DatabaseManager.saveQuestions(questions);
                }
                
                if (cloudStudents && cloudStudents.length > 0) {
                    students = cloudStudents;
                } else {
                    // Use sample data if no cloud data
                    students = [...sampleStudents];
                    await DatabaseManager.saveStudents(students);
                }
                
                // Save to localStorage as backup
                saveDataToStorage();
                
                showNotification('Data berhasil dimuat dari cloud database!', 'success');
            } catch (error) {
                console.error('Error loading from cloud:', error);
                loadDataFromStorage();
            }
        }

        function loadDataFromStorage() {
            // Load questions from localStorage or use sample data
            const savedQuestions = localStorage.getItem('quizQuestions');
            if (savedQuestions) {
                questions = JSON.parse(savedQuestions);
            } else {
                questions = [...sampleQuestions];
                saveDataToStorage();
            }

            // Load students from localStorage or use sample data
            const savedStudents = localStorage.getItem('quizStudents');
            if (savedStudents) {
                students = JSON.parse(savedStudents);
            } else {
                students = [...sampleStudents];
                saveDataToStorage();
            }
        }

        async function resetToSampleData() {
            if (confirm('Apakah Anda yakin ingin mereset semua data ke data contoh? Semua soal dan siswa yang sudah ditambahkan akan hilang!')) {
                // Reset to sample data
                questions = [...sampleQuestions];
                students = [...sampleStudents];
                
                // Save to cloud
                if (DatabaseManager.isInitialized) {
                    await Promise.all([
                        DatabaseManager.saveQuestions(questions),
                        DatabaseManager.saveStudents(students)
                    ]);
                }
                
                // Save to localStorage
                saveDataToStorage();
                
                // Clear results
                localStorage.removeItem('quizResults');
                
                // Refresh display
                loadQuestionsList();
                updateStats();
                
                showNotification('Data berhasil direset ke data contoh!', 'success');
            }
        }

        async function updateStats() {
            document.getElementById('totalQuestionsCount').textContent = questions.length;
            document.getElementById('totalStudents').textContent = students.length;
            
            // Get results from cloud or localStorage
            let results = [];
            if (DatabaseManager.isInitialized) {
                const cloudResults = await DatabaseManager.loadResults();
                if (cloudResults) {
                    results = cloudResults;
                }
            } else {
                results = JSON.parse(localStorage.getItem('quizResults') || '[]');
            }
            
            if (results.length > 0) {
                const avgScore = results.reduce((sum, result) => sum + result.score, 0) / results.length;
                document.getElementById('averageScore').textContent = Math.round(avgScore);
            } else {
                document.getElementById('averageScore').textContent = '0';
            }
        }

        function loadQuestionsList() {
            const container = document.getElementById('questionsList');
            
            if (questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-question-circle text-4xl mb-4"></i>
                        <p>Belum ada soal. Tambahkan soal pertama Anda!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = questions.map((question, index) => `
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium mr-2">
                                    ${question.type === 'multiple_choice' ? 'Pilihan Ganda' : 'Benar/Salah'}
                                </span>
                                <span class="text-sm text-gray-500">Soal #${index + 1}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium ml-2">
                                    <i class="fas fa-cloud mr-1"></i>Cloud Sync
                                </span>
                                ${question.image ? '<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-medium ml-2"><i class="fas fa-image mr-1"></i>Ada Gambar</span>' : ''}
                            </div>
                            <p class="text-gray-900 font-medium mb-2">${question.question}</p>
                            ${question.image ? `<img src="${question.image}" class="max-w-32 h-20 object-cover rounded-lg mb-2" alt="Question image">` : ''}
                            <p class="text-sm text-gray-600">
                                Jawaban: ${question.options[question.correct]}
                            </p>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="editQuestion(${question.id})" class="text-blue-600 hover:text-blue-800 p-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteQuestion(${question.id})" class="text-red-600 hover:text-red-800 p-2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Database Setup Modal
        function showDatabaseSetup() {
            const modal = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">
                        <i class="fas fa-database mr-2 text-blue-600"></i>Setup Database Cloud
                    </h2>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-blue-900 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>Cara Setup Firebase Database
                        </h3>
                        <div class="text-blue-800 text-sm space-y-2">
                            <p><strong>1. Buat Project Firebase:</strong></p>
                            <p>• Buka <a href="https://console.firebase.google.com" target="_blank" class="text-blue-600 underline">Firebase Console</a></p>
                            <p>• Klik "Add project" dan beri nama project</p>
                            <p>• Aktifkan "Realtime Database" di menu Build</p>
                            <br>
                            <p><strong>2. Dapatkan Config:</strong></p>
                            <p>• Masuk ke Project Settings → General</p>
                            <p>• Scroll ke "Your apps" → Web app</p>
                            <p>• Copy Firebase config object</p>
                            <br>
                            <p><strong>3. Ganti Config di Code:</strong></p>
                            <p>• Edit file HTML ini</p>
                            <p>• Cari "firebaseConfig" dan ganti dengan config Anda</p>
                            <p>• Upload ulang file ke hosting</p>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-green-900 mb-2">
                            <i class="fas fa-check-circle mr-2"></i>Keuntungan Database Cloud
                        </h3>
                        <div class="text-green-800 text-sm space-y-1">
                            <p>✅ <strong>Sinkronisasi Otomatis:</strong> Data sync real-time antar device</p>
                            <p>✅ <strong>Multi-Device:</strong> Akses dari HP, laptop, komputer manapun</p>
                            <p>✅ <strong>Backup Otomatis:</strong> Data aman tersimpan di cloud</p>
                            <p>✅ <strong>No Setup:</strong> Siswa langsung bisa akses tanpa setup</p>
                            <p>✅ <strong>Real-time Updates:</strong> Perubahan langsung terlihat</p>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-yellow-900 mb-2">
                            <i class="fas fa-lightbulb mr-2"></i>Status Saat Ini
                        </h3>
                        <div class="text-yellow-800 text-sm">
                            <p><strong>Mode:</strong> Demo Mode (Data tersimpan lokal)</p>
                            <p><strong>Sinkronisasi:</strong> Tidak aktif</p>
                            <p><strong>Multi-Device:</strong> Perlu setup manual</p>
                            <br>
                            <p>Untuk mengaktifkan fitur cloud, ikuti langkah setup di atas.</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            Tutup
                        </button>
                        <a href="https://console.firebase.google.com" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-external-link-alt mr-2"></i>Buka Firebase Console
                        </a>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // Sync functions
        async function syncNow() {
            if (!DatabaseManager.isInitialized) {
                alert('Database belum terhubung! Setup Firebase terlebih dahulu.');
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Syncing...';
            button.disabled = true;
            
            try {
                await Promise.all([
                    DatabaseManager.saveQuestions(questions),
                    DatabaseManager.saveStudents(students)
                ]);
                
                await DatabaseManager.syncData();
                showNotification('Sinkronisasi berhasil!', 'success');
            } catch (error) {
                showNotification('Gagal sinkronisasi: ' + error.message, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Enhanced question management with cloud sync
        async function addQuestionToCloud(question) {
            questions.push(question);
            
            // Save to cloud
            if (DatabaseManager.isInitialized) {
                await DatabaseManager.saveQuestions(questions);
            }
            
            // Save to localStorage as backup
            saveDataToStorage();
        }

        async function updateQuestionInCloud(questionId, updatedQuestion) {
            const index = questions.findIndex(q => q.id === questionId);
            if (index !== -1) {
                questions[index] = updatedQuestion;
                
                // Save to cloud
                if (DatabaseManager.isInitialized) {
                    await DatabaseManager.saveQuestions(questions);
                }
                
                // Save to localStorage as backup
                saveDataToStorage();
            }
        }

        async function deleteQuestionFromCloud(questionId) {
            questions = questions.filter(q => q.id !== questionId);
            
            // Save to cloud
            if (DatabaseManager.isInitialized) {
                await DatabaseManager.saveQuestions(questions);
            }
            
            // Save to localStorage as backup
            saveDataToStorage();
        }

        // Enhanced student management with cloud sync
        async function addStudentToCloud(student) {
            students.push(student);
            
            // Save to cloud
            if (DatabaseManager.isInitialized) {
                await DatabaseManager.saveStudents(students);
            }
            
            // Save to localStorage as backup
            saveDataToStorage();
        }

        async function updateStudentInCloud(studentId, updatedStudent) {
            const index = students.findIndex(s => s.id === studentId);
            if (index !== -1) {
                students[index] = updatedStudent;
                
                // Save to cloud
                if (DatabaseManager.isInitialized) {
                    await DatabaseManager.saveStudents(students);
                }
                
                // Save to localStorage as backup
                saveDataToStorage();
            }
        }

        async function deleteStudentFromCloud(studentId) {
            students = students.filter(s => s.id !== studentId);
            
            // Save to cloud
            if (DatabaseManager.isInitialized) {
                await DatabaseManager.saveStudents(students);
            }
            
            // Save to localStorage as backup
            saveDataToStorage();
        }

        // Student Management Functions (Updated with cloud sync)
        function showStudentManagement() {
            const modal = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900">Manajemen Siswa</h2>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-green-600">
                                <i class="fas fa-cloud mr-1"></i>Auto-sync aktif
                            </span>
                            <button onclick="showAddStudent()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Tambah Siswa
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <button onclick="downloadStudentTemplate()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors mr-2">
                            <i class="fas fa-download mr-2"></i>Download Template
                        </button>
                        <button onclick="showImportStudents()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-upload mr-2"></i>Import Siswa
                        </button>
                    </div>
                    
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left">Username</th>
                                    <th class="px-4 py-2 text-left">Nama</th>
                                    <th class="px-4 py-2 text-left">Kelas</th>
                                    <th class="px-4 py-2 text-center">No. Absen</th>
                                    <th class="px-4 py-2 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.map(student => `
                                    <tr class="border-t">
                                        <td class="px-4 py-2 font-mono text-sm">${student.username}</td>
                                        <td class="px-4 py-2">${student.name}</td>
                                        <td class="px-4 py-2">${student.class}</td>
                                        <td class="px-4 py-2 text-center">${student.number}</td>
                                        <td class="px-4 py-2 text-center">
                                            <button onclick="editStudent(${student.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteStudent(${student.id})" class="text-red-600 hover:text-red-800">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 mt-4 border-t">
                        <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function showAddStudent() {
            const modal = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Tambah Siswa Baru</h2>
                    <form id="addStudentForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" id="studentUsernameAdd" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="text" id="studentPasswordAdd" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                            <input type="text" id="studentNameAdd" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="studentClassAdd" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Pilih Kelas</option>
                                    <option value="7A">7A</option>
                                    <option value="7B">7B</option>
                                    <option value="8A">8A</option>
                                    <option value="8B">8B</option>
                                    <option value="9A">9A</option>
                                    <option value="9B">9B</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Absen</label>
                                <input type="number" id="studentNumberAdd" required min="1" max="40" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-sm text-green-800">
                                <i class="fas fa-cloud mr-2"></i>Data akan otomatis tersinkronisasi ke cloud database
                            </p>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="showStudentManagement()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                                Batal
                            </button>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition-colors">
                                Simpan Siswa
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            modal.classList.remove('hidden');
            
            // Form submission
            document.getElementById('addStudentForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('studentUsernameAdd').value;
                const password = document.getElementById('studentPasswordAdd').value;
                const name = document.getElementById('studentNameAdd').value;
                const studentClass = document.getElementById('studentClassAdd').value;
                const number = parseInt(document.getElementById('studentNumberAdd').value);
                
                // Check if username already exists
                if (students.find(s => s.username === username)) {
                    alert('Username sudah digunakan!');
                    return;
                }
                
                const newStudent = {
                    id: Date.now(),
                    username: username,
                    password: password,
                    name: name,
                    class: studentClass,
                    number: number
                };
                
                await addStudentToCloud(newStudent);
                showStudentManagement();
                updateStats();
                showNotification('Siswa berhasil ditambahkan dan disinkronisasi!', 'success');
            });
        }

        async function editStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;
            
            const modal = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Edit Siswa</h2>
                    <form id="editStudentForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" id="editStudentUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" value="${student.username}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="text" id="editStudentPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" value="${student.password}">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                            <input type="text" id="editStudentName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" value="${student.name}">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="editStudentClass" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Pilih Kelas</option>
                                    <option value="7A" ${student.class === '7A' ? 'selected' : ''}>7A</option>
                                    <option value="7B" ${student.class === '7B' ? 'selected' : ''}>7B</option>
                                    <option value="8A" ${student.class === '8A' ? 'selected' : ''}>8A</option>
                                    <option value="8B" ${student.class === '8B' ? 'selected' : ''}>8B</option>
                                    <option value="9A" ${student.class === '9A' ? 'selected' : ''}>9A</option>
                                    <option value="9B" ${student.class === '9B' ? 'selected' : ''}>9B</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Absen</label>
                                <input type="number" id="editStudentNumber" required min="1" max="40" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" value="${student.number}">
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-sync-alt mr-2"></i>Perubahan akan otomatis tersinkronisasi ke semua device
                            </p>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="showStudentManagement()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                                Batal
                            </button>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition-colors">
                                Update Siswa
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            modal.classList.remove('hidden');
            
            // Form submission
            document.getElementById('editStudentForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('editStudentUsername').value;
                const password = document.getElementById('editStudentPassword').value;
                const name = document.getElementById('editStudentName').value;
                const studentClass = document.getElementById('editStudentClass').value;
                const number = parseInt(document.getElementById('editStudentNumber').value);
                
                // Check if username already exists (excluding current student)
                const existingStudent = students.find(s => s.username === username && s.id !== student.id);
                if (existingStudent) {
                    alert('Username sudah digunakan oleh siswa lain!');
                    return;
                }
                
                const updatedStudent = {
                    ...student,
                    username: username,
                    password: password,
                    name: name,
                    class: studentClass,
                    number: number
                };
                
                await updateStudentInCloud(student.id, updatedStudent);
                showStudentManagement();
                updateStats();
                showNotification('Data siswa berhasil diupdate dan disinkronisasi!', 'success');
            });
        }

        async function deleteStudent(id) {
            if (confirm('Apakah Anda yakin ingin menghapus siswa ini?')) {
                await deleteStudentFromCloud(id);
                showStudentManagement();
                updateStats();
                showNotification('Siswa berhasil dihapus dan disinkronisasi!', 'success');
            }
        }

        // Question management functions (Updated with cloud sync)
        function showAddQuestion() {
            const modal = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Tambah Soal Baru</h2>
                    <form id="addQuestionForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Soal</label>
                            <select id="questionType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="multiple_choice">Pilihan Ganda</option>
                                <option value="true_false">Benar/Salah</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan</label>
                            <textarea id="questionText" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Gambar (Opsional)</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                <input type="file" id="questionImage" accept="image/*" class="hidden">
                                <div id="imagePreview" class="hidden mb-3">
                                    <img id="previewImg" class="max-w-full h-48 object-contain rounded-lg mx-auto">
                                    <button type="button" onclick="removeImage()" class="mt-2 text-red-600 hover:text-red-800 text-sm">
                                        <i class="fas fa-trash mr-1"></i>Hapus Gambar
                                    </button>
                                </div>
                                <div id="imageUploadArea" class="text-center">
                                    <i class="fas fa-image text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-600 mb-2">Klik untuk upload gambar</p>
                                    <button type="button" onclick="document.getElementById('questionImage').click()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                                        <i class="fas fa-upload mr-2"></i>Pilih Gambar
                                    </button>
                                    <p class="text-xs text-gray-500 mt-2">Format: JPG, PNG, GIF (Max: 5MB)</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="optionsContainer">
                            <!-- Options will be generated based on question type -->
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jawaban Benar</label>
                            <select id="correctAnswer" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <!-- Options will be populated -->
                            </select>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <p class="text-sm text-green-800">
                                <i class="fas fa-cloud mr-2"></i>Soal akan otomatis tersinkronisasi ke semua device
                            </p>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                                Batal
                            </button>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition-colors">
                                Simpan Soal
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            modal.classList.remove('hidden');
            
            // Setup form handlers
            setupAddQuestionForm();
        }

        // Image handling functions
        function setupImageUpload() {
            const imageInput = document.getElementById('questionImage');
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const uploadArea = document.getElementById('imageUploadArea');
            
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file size (5MB max)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('Ukuran file terlalu besar! Maksimal 5MB.');
                            return;
                        }
                        
                        // Validate file type
                        if (!file.type.startsWith('image/')) {
                            alert('File harus berupa gambar!');
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImg.src = e.target.result;
                            preview.classList.remove('hidden');
                            uploadArea.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }
        
        function removeImage() {
            const preview = document.getElementById('imagePreview');
            const uploadArea = document.getElementById('imageUploadArea');
            const imageInput = document.getElementById('questionImage');
            
            preview.classList.add('hidden');
            uploadArea.classList.remove('hidden');
            imageInput.value = '';
        }

        function setupAddQuestionForm() {
            const typeSelect = document.getElementById('questionType');
            const optionsContainer = document.getElementById('optionsContainer');
            const correctSelect = document.getElementById('correctAnswer');
            
            // Setup image upload
            setupImageUpload();
            
            function updateOptions() {
                const type = typeSelect.value;
                
                if (type === 'multiple_choice') {
                    optionsContainer.innerHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan Jawaban</label>
                            <div class="space-y-2">
                                <input type="text" id="option0" placeholder="Pilihan A" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                                <input type="text" id="option1" placeholder="Pilihan B" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                                <input type="text" id="option2" placeholder="Pilihan C" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                                <input type="text" id="option3" placeholder="Pilihan D" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                        </div>
                    `;
                    
                    correctSelect.innerHTML = `
                        <option value="0">A</option>
                        <option value="1">B</option>
                        <option value="2">C</option>
                        <option value="3">D</option>
                    `;
                } else {
                    optionsContainer.innerHTML = '';
                    correctSelect.innerHTML = `
                        <option value="0">Benar</option>
                        <option value="1">Salah</option>
                    `;
                }
            }
            
            typeSelect.addEventListener('change', updateOptions);
            updateOptions();
            
            // Form submission
            document.getElementById('addQuestionForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const type = typeSelect.value;
                const questionText = document.getElementById('questionText').value;
                const correct = parseInt(correctSelect.value);
                
                let options = [];
                if (type === 'multiple_choice') {
                    options = [
                        document.getElementById('option0').value,
                        document.getElementById('option1').value,
                        document.getElementById('option2').value,
                        document.getElementById('option3').value
                    ];
                } else {
                    options = ['Benar', 'Salah'];
                }
                
                // Get image data if uploaded
                let imageData = null;
                const previewImg = document.getElementById('previewImg');
                if (previewImg && previewImg.src && previewImg.src.startsWith('data:')) {
                    imageData = previewImg.src;
                }
                
                const newQuestion = {
                    id: Date.now(),
                    type: type,
                    question: questionText,
                    options: options,
                    correct: correct,
                    image: imageData,
                    video: null
                };
                
                await addQuestionToCloud(newQuestion);
                closeModal();
                loadQuestionsList();
                updateStats();
                
                showNotification('Soal berhasil ditambahkan dan disinkronisasi!', 'success');
            });
        }

        async function editQuestion(id) {
            const question = questions.find(q => q.id === id);
            if (!question) return;
            
            // Similar to showAddQuestion but with edit functionality
            // Implementation would be similar to the original editQuestion function
            // but with cloud sync integration
            
            showNotification('Edit soal dengan sinkronisasi cloud!', 'info');
        }

        async function deleteQuestion(id) {
            if (confirm('Apakah Anda yakin ingin menghapus soal ini?')) {
                await deleteQuestionFromCloud(id);
                loadQuestionsList();
                updateStats();
                showNotification('Soal berhasil dihapus dan disinkronisasi!', 'success');
            }
        }

        function saveResult(result) {
            const results = JSON.parse(localStorage.getItem('quizResults') || '[]');
            results.push(result);
            localStorage.setItem('quizResults', JSON.stringify(results));
        }

        async function showResults() {
            let results = [];
            
            // Load results from cloud or localStorage
            if (DatabaseManager.isInitialized) {
                const cloudResults = await DatabaseManager.loadResults();
                if (cloudResults) {
                    results = cloudResults;
                }
            } else {
                results = JSON.parse(localStorage.getItem('quizResults') || '[]');
            }
            
            const modal = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Hasil Quiz Siswa</h2>
                    
                    ${results.length === 0 ? `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-chart-bar text-4xl mb-4"></i>
                            <p>Belum ada hasil quiz.</p>
                        </div>
                    ` : `
                        <div class="mb-4 text-sm text-green-600">
                            <i class="fas fa-cloud mr-1"></i>Data dari cloud database (${results.length} hasil)
                        </div>
                        <div class="max-h-96 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Nama</th>
                                        <th class="px-4 py-2 text-left">Kelas</th>
                                        <th class="px-4 py-2 text-center">Nilai</th>
                                        <th class="px-4 py-2 text-center">Benar</th>
                                        <th class="px-4 py-2 text-left">Waktu</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.map(result => `
                                        <tr class="border-t">
                                            <td class="px-4 py-2">${result.student.name}</td>
                                            <td class="px-4 py-2">${result.student.class}</td>
                                            <td class="px-4 py-2 text-center font-semibold ${result.score >= 70 ? 'text-green-600' : 'text-red-600'}">${result.score}</td>
                                            <td class="px-4 py-2 text-center">${result.correct}/${result.total}</td>
                                            <td class="px-4 py-2">${new Date(result.timestamp).toLocaleString('id-ID')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                    
                    <div class="flex justify-end space-x-3 pt-4 mt-4 border-t">
                        <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            Tutup
                        </button>
                        ${results.length > 0 ? `
                            <button onclick="exportResults()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                                <i class="fas fa-download mr-2"></i>Export Excel
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        async function exportResults() {
            let results = [];
            
            // Load results from cloud or localStorage
            if (DatabaseManager.isInitialized) {
                const cloudResults = await DatabaseManager.loadResults();
                if (cloudResults) {
                    results = cloudResults;
                }
            } else {
                results = JSON.parse(localStorage.getItem('quizResults') || '[]');
            }
            
            if (results.length === 0) {
                alert('Tidak ada data untuk diekspor.');
                return;
            }
            
            // Create CSV content
            let csv = 'Nama,Kelas,No. Absen,Nilai,Benar,Total,Waktu\n';
            
            results.forEach(result => {
                csv += `"${result.student.name}","${result.student.class}","${result.student.number}",${result.score},${result.correct},${result.total},"${new Date(result.timestamp).toLocaleString('id-ID')}"\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `hasil_quiz_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Hasil berhasil diekspor!', 'success');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium transition-all duration-300 transform translate-x-full`;
            
            if (type === 'success') {
                notification.classList.add('bg-green-600');
            } else if (type === 'error') {
                notification.classList.add('bg-red-600');
            } else {
                notification.classList.add('bg-blue-600');
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Close modal when clicking outside
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Import Questions Feature
        function showImportQuestions() {
            const modal = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">
                        <i class="fas fa-file-import mr-2 text-green-600"></i>Import Soal
                    </h2>
                    
                    <div class="mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <h3 class="font-semibold text-blue-900 mb-2">
                                <i class="fas fa-info-circle mr-2"></i>Format File yang Didukung
                            </h3>
                            <div class="text-blue-800 text-sm space-y-1">
                                <p>• <strong>JSON:</strong> Format data QuizMaster</p>
                                <p>• <strong>CSV:</strong> Format spreadsheet (Excel)</p>
                                <p>• <strong>TXT:</strong> Format teks sederhana</p>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <h3 class="font-semibold text-green-900 mb-2">
                                <i class="fas fa-cloud mr-2"></i>Auto-Sync Cloud Database
                            </h3>
                            <p class="text-green-800 text-sm">
                                Soal yang diimport akan otomatis tersinkronisasi ke cloud database dan tersedia di semua device.
                            </p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- File Upload Area -->
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="importFile" accept=".json,.csv,.txt" class="hidden">
                            <div id="uploadArea">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600 mb-4">Pilih file untuk diimport</p>
                                <button type="button" onclick="document.getElementById('importFile').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                    <i class="fas fa-upload mr-2"></i>Pilih File
                                </button>
                                <p class="text-xs text-gray-500 mt-2">JSON, CSV, atau TXT (Max: 10MB)</p>
                            </div>
                            <div id="fileInfo" class="hidden">
                                <i class="fas fa-file text-3xl text-green-600 mb-2"></i>
                                <p id="fileName" class="font-medium text-gray-900"></p>
                                <p id="fileSize" class="text-sm text-gray-600"></p>
                                <button type="button" onclick="clearFile()" class="mt-2 text-red-600 hover:text-red-800 text-sm">
                                    <i class="fas fa-times mr-1"></i>Hapus File
                                </button>
                            </div>
                        </div>
                        
                        <!-- Preview Area -->
                        <div id="previewArea" class="hidden">
                            <h3 class="font-semibold text-gray-900 mb-3">Preview Soal:</h3>
                            <div id="questionsPreview" class="max-h-64 overflow-y-auto bg-gray-50 rounded-lg p-4">
                                <!-- Preview content will be loaded here -->
                            </div>
                            <div class="mt-3 text-sm text-gray-600">
                                <span id="previewCount">0</span> soal siap diimport
                            </div>
                        </div>
                        
                        <!-- Import Options -->
                        <div id="importOptions" class="hidden">
                            <h3 class="font-semibold text-gray-900 mb-3">Opsi Import:</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="importMode" value="add" checked class="mr-2">
                                    <span class="text-sm">Tambahkan ke soal yang sudah ada</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="importMode" value="replace" class="mr-2">
                                    <span class="text-sm">Ganti semua soal yang ada</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-6 mt-6 border-t">
                        <div class="flex space-x-2">
                            <button onclick="downloadTemplate('json')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                <i class="fas fa-download mr-2"></i>Template JSON
                            </button>
                            <button onclick="downloadTemplate('csv')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                <i class="fas fa-download mr-2"></i>Template CSV
                            </button>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                                Batal
                            </button>
                            <button id="importBtn" onclick="importQuestions()" disabled class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-cloud-upload-alt mr-2"></i>Import & Sync
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            setupImportHandlers();
        }
        
        function setupImportHandlers() {
            const fileInput = document.getElementById('importFile');
            const uploadArea = document.getElementById('uploadArea');
            const fileInfo = document.getElementById('fileInfo');
            const previewArea = document.getElementById('previewArea');
            const importOptions = document.getElementById('importOptions');
            const importBtn = document.getElementById('importBtn');
            
            let parsedQuestions = [];
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Validate file size (10MB max)
                if (file.size > 10 * 1024 * 1024) {
                    alert('Ukuran file terlalu besar! Maksimal 10MB.');
                    return;
                }
                
                // Show file info
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = `${(file.size / 1024).toFixed(1)} KB`;
                uploadArea.classList.add('hidden');
                fileInfo.classList.remove('hidden');
                
                // Parse file
                parseImportFile(file);
            });
            
            function parseImportFile(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const extension = file.name.split('.').pop().toLowerCase();
                    
                    try {
                        if (extension === 'json') {
                            parsedQuestions = parseJSONFile(content);
                        } else if (extension === 'csv') {
                            parsedQuestions = parseCSVFile(content);
                        } else if (extension === 'txt') {
                            parsedQuestions = parseTXTFile(content);
                        }
                        
                        if (parsedQuestions.length > 0) {
                            showPreview(parsedQuestions);
                            previewArea.classList.remove('hidden');
                            importOptions.classList.remove('hidden');
                            importBtn.disabled = false;
                        } else {
                            alert('Tidak ada soal valid yang ditemukan dalam file.');
                        }
                    } catch (error) {
                        alert('Error parsing file: ' + error.message);
                        console.error('Parse error:', error);
                    }
                };
                reader.readAsText(file);
            }
            
            function parseJSONFile(content) {
                const data = JSON.parse(content);
                
                // Handle different JSON formats
                let questionsArray = [];
                
                if (Array.isArray(data)) {
                    questionsArray = data;
                } else if (data.questions && Array.isArray(data.questions)) {
                    questionsArray = data.questions;
                } else if (data.quiz && Array.isArray(data.quiz)) {
                    questionsArray = data.quiz;
                }
                
                return questionsArray.map((q, index) => ({
                    id: Date.now() + index,
                    type: q.type || 'multiple_choice',
                    question: q.question || q.text || q.soal || '',
                    options: q.options || q.choices || q.pilihan || [],
                    correct: parseInt(q.correct || q.answer || q.jawaban || 0),
                    image: q.image || null,
                    video: q.video || null
                })).filter(q => q.question && q.options.length > 0);
            }
            
            function parseCSVFile(content) {
                const lines = content.split('\n').filter(line => line.trim());
                const questionsArray = [];
                
                // Skip header if exists
                const startIndex = lines[0].toLowerCase().includes('question') || lines[0].toLowerCase().includes('soal') ? 1 : 0;
                
                for (let i = startIndex; i < lines.length; i++) {
                    const columns = parseCSVLine(lines[i]);
                    if (columns.length >= 6) { // question, optionA, optionB, optionC, optionD, correct
                        const question = {
                            id: Date.now() + i,
                            type: 'multiple_choice',
                            question: columns[0].trim(),
                            options: [
                                columns[1].trim(),
                                columns[2].trim(),
                                columns[3].trim(),
                                columns[4].trim()
                            ],
                            correct: parseInt(columns[5]) || 0,
                            image: null,
                            video: null
                        };
                        
                        if (question.question && question.options.every(opt => opt)) {
                            questionsArray.push(question);
                        }
                    }
                }
                
                return questionsArray;
            }
            
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current);
                return result;
            }
            
            function parseTXTFile(content) {
                const lines = content.split('\n').filter(line => line.trim());
                const questionsArray = [];
                let currentQuestion = null;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Check if line starts with number (new question)
                    if (/^\d+\./.test(line)) {
                        if (currentQuestion && currentQuestion.question && currentQuestion.options.length > 0) {
                            questionsArray.push(currentQuestion);
                        }
                        
                        currentQuestion = {
                            id: Date.now() + i,
                            type: 'multiple_choice',
                            question: line.replace(/^\d+\.\s*/, ''),
                            options: [],
                            correct: 0,
                            image: null,
                            video: null
                        };
                    }
                    // Check if line is an option (A., B., C., D.)
                    else if (/^[A-D]\./.test(line) && currentQuestion) {
                        currentQuestion.options.push(line.replace(/^[A-D]\.\s*/, ''));
                    }
                    // Check if line indicates correct answer
                    else if (/^(jawaban|answer|correct):/i.test(line) && currentQuestion) {
                        const answerMatch = line.match(/[A-D]/i);
                        if (answerMatch) {
                            currentQuestion.correct = answerMatch[0].toUpperCase().charCodeAt(0) - 65;
                        }
                    }
                }
                
                // Add last question
                if (currentQuestion && currentQuestion.question && currentQuestion.options.length > 0) {
                    questionsArray.push(currentQuestion);
                }
                
                return questionsArray;
            }
            
            function showPreview(questions) {
                const preview = document.getElementById('questionsPreview');
                const count = document.getElementById('previewCount');
                
                count.textContent = questions.length;
                
                preview.innerHTML = questions.slice(0, 5).map((q, index) => `
                    <div class="bg-white rounded-lg p-3 mb-3 border">
                        <div class="flex items-center mb-2">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium mr-2">
                                ${q.type === 'multiple_choice' ? 'Pilihan Ganda' : 'Benar/Salah'}
                            </span>
                            <span class="text-xs text-gray-500">Preview #${index + 1}</span>
                        </div>
                        <p class="font-medium text-sm mb-2">${q.question}</p>
                        <div class="text-xs text-gray-600">
                            ${q.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join(' | ')}
                        </div>
                        <div class="text-xs text-green-600 mt-1">
                            Jawaban: ${String.fromCharCode(65 + q.correct)}
                        </div>
                    </div>
                `).join('') + (questions.length > 5 ? `
                    <div class="text-center text-gray-500 text-sm">
                        ... dan ${questions.length - 5} soal lainnya
                    </div>
                ` : '');
            }
            
            window.importQuestions = async function() {
                if (parsedQuestions.length === 0) return;
                
                const importMode = document.querySelector('input[name="importMode"]:checked').value;
                const button = document.getElementById('importBtn');
                const originalText = button.innerHTML;
                
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Importing...';
                button.disabled = true;
                
                try {
                    if (importMode === 'replace') {
                        questions = [...parsedQuestions];
                    } else {
                        // Add to existing questions with new IDs
                        const newQuestions = parsedQuestions.map(q => ({
                            ...q,
                            id: Date.now() + Math.random()
                        }));
                        questions = [...questions, ...newQuestions];
                    }
                    
                    // Save to cloud database
                    if (DatabaseManager.isInitialized) {
                        await DatabaseManager.saveQuestions(questions);
                        showNotification(`${parsedQuestions.length} soal berhasil diimport dan disinkronisasi ke cloud!`, 'success');
                    } else {
                        showNotification(`${parsedQuestions.length} soal berhasil diimport (tersimpan lokal)!`, 'success');
                    }
                    
                    // Save to localStorage as backup
                    saveDataToStorage();
                    
                    // Update UI
                    loadQuestionsList();
                    updateStats();
                    
                    closeModal();
                } catch (error) {
                    showNotification('Error saat import: ' + error.message, 'error');
                    console.error('Import error:', error);
                } finally {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            };
            
            window.clearFile = function() {
                fileInput.value = '';
                uploadArea.classList.remove('hidden');
                fileInfo.classList.add('hidden');
                previewArea.classList.add('hidden');
                importOptions.classList.add('hidden');
                importBtn.disabled = true;
                parsedQuestions = [];
            };
        }
        
        function downloadTemplate(format) {
            const sampleQuestions = [
                {
                    question: "Apa yang dimaksud dengan algoritma?",
                    optionA: "Bahasa pemrograman",
                    optionB: "Langkah-langkah sistematis untuk menyelesaikan masalah",
                    optionC: "Perangkat keras komputer",
                    optionD: "Sistem operasi",
                    correct: 1
                },
                {
                    question: "Manakah yang bukan termasuk struktur kontrol?",
                    optionA: "Sequence (Urutan)",
                    optionB: "Selection (Pemilihan)",
                    optionC: "Iteration (Perulangan)",
                    optionD: "Compilation (Kompilasi)",
                    correct: 3
                }
            ];
            
            let content = '';
            let filename = '';
            let mimeType = '';
            
            if (format === 'json') {
                const jsonData = sampleQuestions.map((q, index) => ({
                    id: index + 1,
                    type: "multiple_choice",
                    question: q.question,
                    options: [q.optionA, q.optionB, q.optionC, q.optionD],
                    correct: q.correct,
                    image: null,
                    video: null
                }));
                
                content = JSON.stringify(jsonData, null, 2);
                filename = 'template_soal.json';
                mimeType = 'application/json';
            } else if (format === 'csv') {
                content = 'Question,Option A,Option B,Option C,Option D,Correct Answer (0-3)\n';
                sampleQuestions.forEach(q => {
                    content += `"${q.question}","${q.optionA}","${q.optionB}","${q.optionC}","${q.optionD}",${q.correct}\n`;
                });
                filename = 'template_soal.csv';
                mimeType = 'text/csv';
            }
            
            // Download file
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Template ${format.toUpperCase()} berhasil didownload!`, 'success');
        }

        function showImportStudents() {
            const modal = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">
                        <i class="fas fa-users mr-2 text-blue-600"></i>Import Data Siswa
                    </h2>
                    
                    <div class="mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <h3 class="font-semibold text-blue-900 mb-2">
                                <i class="fas fa-info-circle mr-2"></i>Format File yang Didukung
                            </h3>
                            <div class="text-blue-800 text-sm space-y-1">
                                <p>• <strong>CSV:</strong> Format Excel/Spreadsheet</p>
                                <p>• <strong>JSON:</strong> Format data QuizMaster</p>
                                <p>• <strong>TXT:</strong> Format teks sederhana</p>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                            <h3 class="font-semibold text-green-900 mb-2">
                                <i class="fas fa-cloud mr-2"></i>Auto-Sync Cloud Database
                            </h3>
                            <p class="text-green-800 text-sm">
                                Data siswa yang diimport akan otomatis tersinkronisasi ke cloud database dan tersedia di semua device.
                            </p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- File Upload Area -->
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center drop-zone" id="studentDropZone">
                            <input type="file" id="importStudentFile" accept=".json,.csv,.txt" class="hidden">
                            <div id="studentUploadArea">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600 mb-4">Drag & drop file atau klik untuk pilih</p>
                                <button type="button" onclick="document.getElementById('importStudentFile').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                    <i class="fas fa-upload mr-2"></i>Pilih File
                                </button>
                                <p class="text-xs text-gray-500 mt-2">CSV, JSON, atau TXT (Max: 5MB)</p>
                            </div>
                            <div id="studentFileInfo" class="hidden">
                                <i class="fas fa-file text-3xl text-green-600 mb-2"></i>
                                <p id="studentFileName" class="font-medium text-gray-900"></p>
                                <p id="studentFileSize" class="text-sm text-gray-600"></p>
                                <button type="button" onclick="clearStudentFile()" class="mt-2 text-red-600 hover:text-red-800 text-sm">
                                    <i class="fas fa-times mr-1"></i>Hapus File
                                </button>
                            </div>
                        </div>
                        
                        <!-- Preview Area -->
                        <div id="studentPreviewArea" class="hidden">
                            <h3 class="font-semibold text-gray-900 mb-3">Preview Data Siswa:</h3>
                            <div id="studentsPreview" class="max-h-64 overflow-y-auto bg-gray-50 rounded-lg p-4">
                                <!-- Preview content will be loaded here -->
                            </div>
                            <div class="mt-3 text-sm text-gray-600">
                                <span id="studentPreviewCount">0</span> siswa siap diimport
                            </div>
                        </div>
                        
                        <!-- Import Options -->
                        <div id="studentImportOptions" class="hidden">
                            <h3 class="font-semibold text-gray-900 mb-3">Opsi Import:</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="studentImportMode" value="add" checked class="mr-2">
                                    <span class="text-sm">Tambahkan ke data siswa yang sudah ada</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="studentImportMode" value="replace" class="mr-2">
                                    <span class="text-sm">Ganti semua data siswa yang ada</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="studentImportMode" value="update" class="mr-2">
                                    <span class="text-sm">Update data siswa yang sudah ada (berdasarkan username)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-6 mt-6 border-t">
                        <div class="flex space-x-2">
                            <button onclick="downloadStudentTemplate('csv')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                <i class="fas fa-download mr-2"></i>Template CSV
                            </button>
                            <button onclick="downloadStudentTemplate('json')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                <i class="fas fa-download mr-2"></i>Template JSON
                            </button>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="showStudentManagement()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                                Batal
                            </button>
                            <button id="importStudentBtn" onclick="importStudents()" disabled class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-cloud-upload-alt mr-2"></i>Import & Sync
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            setupStudentImportHandlers();
        }

        function setupStudentImportHandlers() {
            const fileInput = document.getElementById('importStudentFile');
            const dropZone = document.getElementById('studentDropZone');
            const uploadArea = document.getElementById('studentUploadArea');
            const fileInfo = document.getElementById('studentFileInfo');
            const previewArea = document.getElementById('studentPreviewArea');
            const importOptions = document.getElementById('studentImportOptions');
            const importBtn = document.getElementById('importStudentBtn');
            
            let parsedStudents = [];
            
            // Drag and drop handlers
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleStudentFile(files[0]);
                }
            });
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleStudentFile(file);
                }
            });
            
            function handleStudentFile(file) {
                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Ukuran file terlalu besar! Maksimal 5MB.');
                    return;
                }
                
                // Validate file type
                const extension = file.name.split('.').pop().toLowerCase();
                if (!['csv', 'json', 'txt'].includes(extension)) {
                    alert('Format file tidak didukung! Gunakan CSV, JSON, atau TXT.');
                    return;
                }
                
                // Show file info
                document.getElementById('studentFileName').textContent = file.name;
                document.getElementById('studentFileSize').textContent = `${(file.size / 1024).toFixed(1)} KB`;
                uploadArea.classList.add('hidden');
                fileInfo.classList.remove('hidden');
                
                // Parse file
                parseStudentFile(file);
            }
            
            function parseStudentFile(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const extension = file.name.split('.').pop().toLowerCase();
                    
                    try {
                        if (extension === 'json') {
                            parsedStudents = parseStudentJSONFile(content);
                        } else if (extension === 'csv') {
                            parsedStudents = parseStudentCSVFile(content);
                        } else if (extension === 'txt') {
                            parsedStudents = parseStudentTXTFile(content);
                        }
                        
                        if (parsedStudents.length > 0) {
                            showStudentPreview(parsedStudents);
                            previewArea.classList.remove('hidden');
                            importOptions.classList.remove('hidden');
                            importBtn.disabled = false;
                        } else {
                            alert('Tidak ada data siswa valid yang ditemukan dalam file.');
                        }
                    } catch (error) {
                        alert('Error parsing file: ' + error.message);
                        console.error('Parse error:', error);
                    }
                };
                reader.readAsText(file);
            }
            
            function parseStudentJSONFile(content) {
                const data = JSON.parse(content);
                
                // Handle different JSON formats
                let studentsArray = [];
                
                if (Array.isArray(data)) {
                    studentsArray = data;
                } else if (data.students && Array.isArray(data.students)) {
                    studentsArray = data.students;
                } else if (data.siswa && Array.isArray(data.siswa)) {
                    studentsArray = data.siswa;
                }
                
                return studentsArray.map((s, index) => ({
                    id: Date.now() + index,
                    username: s.username || s.user || s.id || '',
                    password: s.password || s.pass || s.pwd || 'pass123',
                    name: s.name || s.nama || s.fullname || '',
                    class: s.class || s.kelas || s.grade || '',
                    number: parseInt(s.number || s.no || s.absen || s.nomor || 0)
                })).filter(s => s.username && s.name);
            }
            
            function parseStudentCSVFile(content) {
                const lines = content.split('\n').filter(line => line.trim());
                const studentsArray = [];
                
                // Skip header if exists
                const startIndex = lines[0].toLowerCase().includes('username') || 
                                 lines[0].toLowerCase().includes('nama') ? 1 : 0;
                
                for (let i = startIndex; i < lines.length; i++) {
                    const columns = parseCSVLine(lines[i]);
                    if (columns.length >= 4) { // username, password, name, class, number
                        const student = {
                            id: Date.now() + i,
                            username: columns[0].trim(),
                            password: columns[1].trim() || 'pass123',
                            name: columns[2].trim(),
                            class: columns[3].trim(),
                            number: parseInt(columns[4]) || 0
                        };
                        
                        if (student.username && student.name) {
                            studentsArray.push(student);
                        }
                    }
                }
                
                return studentsArray;
            }
            
            function parseStudentTXTFile(content) {
                const lines = content.split('\n').filter(line => line.trim());
                const studentsArray = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Format: username|password|name|class|number
                    // or: username,password,name,class,number
                    const parts = line.split(/[|,\t]/).map(p => p.trim());
                    
                    if (parts.length >= 3) {
                        const student = {
                            id: Date.now() + i,
                            username: parts[0],
                            password: parts[1] || 'pass123',
                            name: parts[2],
                            class: parts[3] || '',
                            number: parseInt(parts[4]) || 0
                        };
                        
                        if (student.username && student.name) {
                            studentsArray.push(student);
                        }
                    }
                }
                
                return studentsArray;
            }
            
            function showStudentPreview(studentList) {
                const preview = document.getElementById('studentsPreview');
                const count = document.getElementById('studentPreviewCount');
                
                count.textContent = studentList.length;
                
                preview.innerHTML = studentList.slice(0, 10).map((s, index) => `
                    <div class="bg-white rounded-lg p-3 mb-3 border">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center mb-1">
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium mr-2">
                                        Preview #${index + 1}
                                    </span>
                                    <span class="text-xs text-gray-500 font-mono">${s.username}</span>
                                </div>
                                <p class="font-medium text-sm">${s.name}</p>
                                <div class="text-xs text-gray-600">
                                    Kelas: ${s.class} | No. Absen: ${s.number} | Password: ${s.password}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('') + (studentList.length > 10 ? `
                    <div class="text-center text-gray-500 text-sm">
                        ... dan ${studentList.length - 10} siswa lainnya
                    </div>
                ` : '');
            }
            
            window.importStudents = async function() {
                if (parsedStudents.length === 0) return;
                
                const importMode = document.querySelector('input[name="studentImportMode"]:checked').value;
                const button = document.getElementById('importStudentBtn');
                const originalText = button.innerHTML;
                
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Importing...';
                button.disabled = true;
                
                try {
                    let duplicateCount = 0;
                    let addedCount = 0;
                    let updatedCount = 0;
                    
                    if (importMode === 'replace') {
                        students = [...parsedStudents];
                        addedCount = parsedStudents.length;
                    } else if (importMode === 'add') {
                        // Add new students, skip duplicates
                        for (const newStudent of parsedStudents) {
                            const exists = students.find(s => s.username === newStudent.username);
                            if (!exists) {
                                students.push({
                                    ...newStudent,
                                    id: Date.now() + Math.random()
                                });
                                addedCount++;
                            } else {
                                duplicateCount++;
                            }
                        }
                    } else if (importMode === 'update') {
                        // Update existing students, add new ones
                        for (const newStudent of parsedStudents) {
                            const existingIndex = students.findIndex(s => s.username === newStudent.username);
                            if (existingIndex !== -1) {
                                students[existingIndex] = {
                                    ...students[existingIndex],
                                    ...newStudent,
                                    id: students[existingIndex].id // Keep original ID
                                };
                                updatedCount++;
                            } else {
                                students.push({
                                    ...newStudent,
                                    id: Date.now() + Math.random()
                                });
                                addedCount++;
                            }
                        }
                    }
                    
                    // Save to cloud database
                    if (DatabaseManager.isInitialized) {
                        await DatabaseManager.saveStudents(students);
                    }
                    
                    // Save to localStorage as backup
                    saveDataToStorage();
                    
                    // Update UI
                    showStudentManagement();
                    updateStats();
                    
                    // Show success message
                    let message = '';
                    if (importMode === 'replace') {
                        message = `${addedCount} siswa berhasil diimport (mengganti semua data)`;
                    } else {
                        const parts = [];
                        if (addedCount > 0) parts.push(`${addedCount} siswa ditambahkan`);
                        if (updatedCount > 0) parts.push(`${updatedCount} siswa diupdate`);
                        if (duplicateCount > 0) parts.push(`${duplicateCount} duplikat dilewati`);
                        message = parts.join(', ');
                    }
                    
                    if (DatabaseManager.isInitialized) {
                        message += ' dan disinkronisasi ke cloud!';
                    } else {
                        message += ' (tersimpan lokal)!';
                    }
                    
                    showNotification(message, 'success');
                    
                } catch (error) {
                    showNotification('Error saat import: ' + error.message, 'error');
                    console.error('Import error:', error);
                } finally {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            };
            
            window.clearStudentFile = function() {
                fileInput.value = '';
                uploadArea.classList.remove('hidden');
                fileInfo.classList.add('hidden');
                previewArea.classList.add('hidden');
                importOptions.classList.add('hidden');
                importBtn.disabled = true;
                parsedStudents = [];
            };
        }

        function downloadStudentTemplate(format) {
            const sampleStudents = [
                {
                    username: "siswa001",
                    password: "pass123",
                    name: "Ahmad Rizki Pratama",
                    class: "7A",
                    number: 1
                },
                {
                    username: "siswa002", 
                    password: "pass123",
                    name: "Siti Nurhaliza",
                    class: "7A",
                    number: 2
                },
                {
                    username: "siswa003",
                    password: "pass123", 
                    name: "Budi Santoso",
                    class: "7B",
                    number: 1
                },
                {
                    username: "siswa004",
                    password: "pass123",
                    name: "Dewi Sartika",
                    class: "7B", 
                    number: 2
                }
            ];
            
            let content = '';
            let filename = '';
            let mimeType = '';
            
            if (format === 'json') {
                content = JSON.stringify(sampleStudents, null, 2);
                filename = 'template_siswa.json';
                mimeType = 'application/json';
            } else if (format === 'csv') {
                content = 'Username,Password,Nama Lengkap,Kelas,No Absen\n';
                sampleStudents.forEach(s => {
                    content += `"${s.username}","${s.password}","${s.name}","${s.class}",${s.number}\n`;
                });
                filename = 'template_siswa.csv';
                mimeType = 'text/csv';
            }
            
            // Download file
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Template siswa ${format.toUpperCase()} berhasil didownload!`, 'success');
        }

        function showQuestionNav() {
            showNotification('Navigasi soal akan segera tersedia!', 'info');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9805f697c1a8ce73',t:'MTc1ODA4NDQyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
